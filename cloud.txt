#cloud-config
user: root
password: root
chpasswd: {expire: False}
ssh_pwauth: True
write_files:
- content: |
    #!/bin/bash
    /root/go/bin/dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient --check-go-version=false exec /opt/kata/bin/kata-runtime -- $*
  path: /opt/kata/bin/kata-runtime-debug
  permissions: '0755'
- content: |
    #!/bin/bash
    set -ex
    wget -q https://go.dev/dl/go1.20.4.linux-amd64.tar.gz
    rm -rf /usr/local/go && tar -C /usr/local -xzf go1.20.4.linux-amd64.tar.gz
    export PATH=$PATH:/usr/local/go/bin
    go env
    export GOPATH=/root/go
    export GOCACHE=/root/.cache/go-build
    export GOENV=/root/.config/go/env
    export GOMODCACHE=/root/go/pkg/mod
    go install github.com/go-delve/delve/cmd/dlv@latest
    echo $?
    echo '{"runtimes": {"kata-runtime": {"path": "/opt/kata/bin/kata-runtime"}, "kata-runtime-debug": {"path": "/opt/kata/bin/kata-runtime-debug"}}}' >> /etc/docker/daemon.json
    sync
    echo "/init.sh complete"
  path: /init.sh
  permissions: '0755'
runcmd:
  - /init.sh
cloud_init_modules:
  - [ write-files, always ]
cloud_config_modules:
  - [ runcmd, always ]
  - [ set-passwords, always ]
cloud_final_modules:
  - [ scripts-user, always ]
  - [ final-message, always ]